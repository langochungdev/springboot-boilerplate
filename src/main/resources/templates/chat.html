<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chat + File + Call Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>Test Chat + File + Call</h2>

<!-- Nút login -->
<button onclick="login('user','123')">Login User</button>
<button onclick="login('admin','123')">Login Admin</button>
<div id="status"></div>

<hr>
<!-- Tạo chat -->
<input type="text" id="chatName" placeholder="Tên chat"/>
<input type="text" id="memberIds" placeholder="ID thành viên, cách nhau bởi dấu phẩy"/>
<button onclick="createChat()">Tạo Chat</button>
<div id="createdChat"></div>

<hr>
<!-- Chat -->
<input type="text" id="chatId" placeholder="Chat ID"/>
<input type="text" id="msg" placeholder="Tin nhắn"/>
<button onclick="sendMessage()">Gửi</button>
<br>
<input type="file" id="fileInput" multiple/>
<button onclick="sendFile()">Gửi File/Ảnh</button>

<div id="messages" style="border:1px solid #ccc;margin-top:10px;padding:10px;height:200px;overflow:auto"></div>

<hr>
<!-- Call -->
<button onclick="startCall()">Start Call</button>
<button onclick="hangup()">Hangup</button>
<br>
<video id="localVideo" autoplay muted playsinline style="width:200px;border:1px solid black"></video>
<video id="remoteVideo" autoplay playsinline style="width:200px;border:1px solid black"></video>

<script>
    let stompClient = null;
    let currentUser = null;
    let pc = null;

    async function login(username, password) {
        const res = await fetch("http://localhost:8080/api/auth/login", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({username,password}),
            credentials: "include"
        });
        if(res.ok){
            const data = await res.json();
            currentUser = data.user;
            document.getElementById("status").innerText = "Logged in: " + currentUser.username;
            connectWS();
        } else {
            alert("Login failed");
        }
    }

    function connectWS(){
        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, frame => {
            console.log("CONNECTED:", frame);
            subscribeChat();
            stompClient.subscribe("/topic/call", msg => {
                const data = JSON.parse(msg.body);
                if (data.from !== currentUser.username) handleSignal(data);
            });
        });
    }

    function subscribeChat(){
        if(!stompClient || !currentUser) return;
        const chatId = document.getElementById("chatId").value;
        if(!chatId) return;
        const dest = "/topic/chat/" + chatId + "/user/" + currentUser.id;
        stompClient.subscribe(dest, msg => {
            const m = JSON.parse(msg.body);
            document.getElementById("messages").innerHTML +=
                "<div><b>"+(m.sender?.username||"")+"</b>: "+m.content+"</div>";
        });
    }

    async function createChat(){
        const name = document.getElementById("chatName").value;
        const memberIds = document.getElementById("memberIds").value
            .split(",").map(s=>s.trim()).filter(s=>s);
        const res = await fetch("http://localhost:8080/api/chats", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            credentials: "include",
            body: JSON.stringify({name, memberIds})
        });
        if(res.ok){
            const chat = await res.json();
            document.getElementById("chatId").value = chat.id;
            document.getElementById("createdChat").innerText = "Created chat: " + chat.id;
            subscribeChat();
        }else{
            alert("Tạo chat thất bại");
        }
    }

    function sendMessage(){
        const chatId = document.getElementById("chatId").value;
        const content = document.getElementById("msg").value;
        const form = new FormData();
        form.append("content", content);
        fetch(`http://localhost:8080/api/chats/${chatId}/messages`, {
            method: "POST",
            body: form,
            credentials: "include"
        });
    }

    function sendFile(){
        const chatId = document.getElementById("chatId").value;
        const files = document.getElementById("fileInput").files;
        const form = new FormData();
        form.append("content", "[file]");
        for (let f of files) form.append("files", f);
        fetch(`http://localhost:8080/api/chats/${chatId}/messages`, {
            method: "POST",
            body: form,
            credentials: "include"
        });
    }

    async function startCall() {
        pc = new RTCPeerConnection();
        pc.onicecandidate = e => {
            if (e.candidate) sendSignal({type:"candidate", candidate:e.candidate});
        };
        pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

        const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        localVideo.srcObject = stream;

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendSignal({type:"offer", sdp:offer.sdp});
    }

    async function handleSignal(msg) {
        if (!pc) {
            pc = new RTCPeerConnection();
            pc.onicecandidate = e => {
                if (e.candidate) sendSignal({type:"candidate", candidate:e.candidate});
            };
            pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
            const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            stream.getTracks().forEach(t => pc.addTrack(t, stream));
            localVideo.srcObject = stream;
        }

        if (msg.type === "offer") {
            await pc.setRemoteDescription({type:"offer", sdp:msg.sdp});
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            sendSignal({type:"answer", sdp:answer.sdp});
        } else if (msg.type === "answer") {
            await pc.setRemoteDescription({type:"answer", sdp:msg.sdp});
        } else if (msg.type === "candidate") {
            await pc.addIceCandidate(msg.candidate);
        }
    }

    function sendSignal(data) {
        data.from = currentUser.username;
        stompClient.send("/app/call", {}, JSON.stringify(data));
    }

    function hangup() {
        if (pc) {
            pc.close();
            pc = null;
        }
    }
</script>
</body>
</html>
