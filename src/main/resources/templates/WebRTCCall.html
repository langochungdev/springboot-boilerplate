<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test WebRTC Call - Instar</title>
</head>
<body>
<h2>Test Call WebRTC + STOMP</h2>
<div>
    <label>User Name: <input id="username" value="user1"/></label>
    <button onclick="connectWS()">Connect Signaling</button>
</div>
<video id="localVideo" autoplay muted style="width: 300px; border: 1px solid #333; display: none;"></video>
<video id="remoteVideo" autoplay style="width: 300px; border: 1px solid #333; display: none;"></video>
<audio id="localAudio" autoplay muted style="display: none;"></audio>
<audio id="remoteAudio" autoplay style="display: none;"></audio>
<div>
    <button onclick="startCall('audio')">Gọi audio</button>
    <button onclick="startCall('video')">Gọi video</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;
    let pc = null;
    let localStream = null;
    let username = '';
    let target = '';
    let callType = 'video';

    function connectWS() {
        username = document.getElementById('username').value.trim();
        // stompClient = Stomp.over(new SockJS('http://localhost:8080/ws'));
        stompClient = Stomp.over(new SockJS('http://172.16.2.167:8080/ws'));

        stompClient.connect({}, function () {
            stompClient.subscribe('/topic/call', function (msg) {
                let data = JSON.parse(msg.body);
                if (data.from === username) return; // bỏ qua tín hiệu mình gửi

                if (data.type === 'offer') {
                    target = data.from;
                    callType = data.callType || 'video';
                    onOffer(data);
                }
                if (data.type === 'answer') {
                    onAnswer(data);
                }
                if (data.type === 'candidate') {
                    onCandidate(data);
                }
            });
            alert('Đã kết nối signaling');
        });
    }

    async function startCall(type) {
        callType = type;
        target = prompt('Gọi tới user nào? (gõ đúng username phía bên kia)');
        await setupWebRTC(type);

        let offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        sendSignal({
            type: 'offer',
            from: username,
            to: target,
            sdp: offer.sdp,
            callType: type
        });
    }

    function sendSignal(msg) {
        stompClient.send("/app/call", {}, JSON.stringify(msg));
    }

    async function setupWebRTC(type) {
        if (pc) pc.close();
        pc = new RTCPeerConnection();

        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }

        if (type === 'audio') {
            localStream = await navigator.mediaDevices.getUserMedia({video: false, audio: true});
            document.getElementById('localAudio').srcObject = localStream;
            document.getElementById('localAudio').style.display = '';
            document.getElementById('localVideo').style.display = 'none';
        } else {
            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('localVideo').srcObject = localStream;
            document.getElementById('localVideo').style.display = '';
            document.getElementById('localAudio').style.display = 'none';
        }

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.ontrack = event => {
            if (callType === 'audio') {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
                document.getElementById('remoteAudio').style.display = '';
                document.getElementById('remoteVideo').style.display = 'none';
            } else {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                document.getElementById('remoteVideo').style.display = '';
                document.getElementById('remoteAudio').style.display = 'none';
            }
        };
        pc.onicecandidate = event => {
            if (event.candidate) {
                sendSignal({
                    type: 'candidate',
                    from: username,
                    to: target,
                    candidate: event.candidate
                });
            }
        };
    }

    async function onOffer(data) {
        await setupWebRTC(data.callType || 'video');
        await pc.setRemoteDescription({type: 'offer', sdp: data.sdp});
        let answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        sendSignal({
            type: 'answer',
            from: username,
            to: data.from,
            sdp: answer.sdp,
            callType: data.callType
        });
    }

    async function onAnswer(data) {
        await pc.setRemoteDescription({type: 'answer', sdp: data.sdp});
    }

    function onCandidate(data) {
        if (pc) pc.addIceCandidate(data.candidate);
    }
</script>
</body>
</html>
